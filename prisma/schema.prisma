generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model user {
  id                String    @id @default(cuid()) @db.VarChar(25)
  email             String    @unique @db.VarChar(191)
  passwordHash      String    @db.VarChar(255)
  firstName         String    @db.VarChar(100)
  lastName          String    @db.VarChar(100)
  name              String?   @db.VarChar(191)
  role              user_role @default(STUDENT)
  deviceId          String?   @db.VarChar(100) // Device ID lié au compte (pour les étudiants)
  mustChangePassword Boolean  @default(false) // Si true, l'utilisateur doit changer son mot de passe à la prochaine connexion
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  professorTeachings  professorTeaching[]
  professorAssignments professorAssignment[]
  enrollments         enrollment[]
  attendances         attendance[]
  justifications      justification[]
  teachingSeances     seance[] @relation("ProfSeances")

  @@map("user")
}

enum user_role {
  ADMIN
  PROF
  STUDENT
}

model filiere {
  id        String   @id @default(cuid()) @db.VarChar(25)
  name      String   @unique @db.VarChar(191)
  code      String   @unique @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  groupe  groupe[]
  modules module[]
  seances seance[]

  @@map("filiere")
}

model groupe {
  id         String   @id @default(cuid()) @db.VarChar(25)
  name       String   @db.VarChar(191)
  code       String   @unique @db.VarChar(50)
  filiereId  String   @db.VarChar(25)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  filiere      filiere      @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  enrollments  enrollment[]
  seances      seance[]
  professorAssignments professorAssignment[]

  @@map("groupe")
}

model module {
  id        String   @id @default(cuid()) @db.VarChar(25)
  name      String   @db.VarChar(191)
  code      String   @unique @db.VarChar(50)
  filiereId String   @db.VarChar(25)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  filiere            filiere             @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  seance             seance[]
  professorTeachings professorTeaching[]
  professorAssignments professorAssignment[]

  @@unique([name, filiereId])
  @@map("module")
}

model professorTeaching {
  id        String   @id @default(cuid()) @db.VarChar(25)
  profId    String   @db.VarChar(25)
  moduleId  String   @db.VarChar(25)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professor user   @relation(fields: [profId], references: [id], onDelete: Cascade)
  module    module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([profId, moduleId])
  @@map("professorteaching")
}

model professorAssignment {
  id        String   @id @default(cuid()) @db.VarChar(25)
  profId    String   @db.VarChar(25)
  moduleId  String   @db.VarChar(25)
  groupeId  String   @db.VarChar(25)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professor user   @relation(fields: [profId], references: [id], onDelete: Cascade)
  module    module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  groupe    groupe @relation(fields: [groupeId], references: [id], onDelete: Cascade)

  @@unique([profId, moduleId, groupeId])
  @@map("professorassignment")
}

model seance {
  id        String        @id @default(cuid()) @db.VarChar(25)
  date      DateTime
  startTime String        @db.VarChar(10)
  endTime   String        @db.VarChar(10)
  status    seance_status @default(PLANNED)
  qrSecret  String?       @db.VarChar(255)
  qrFrozen  Boolean       @default(false) // Si true, le QR n'change pas
  confirmed Boolean       @default(false) // Si true, le prof a confirmé la séance
  filiereId String        @db.VarChar(25)
  moduleId  String        @db.VarChar(25)
  groupeId  String        @db.VarChar(25)
  profId   String?        @db.VarChar(25)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  filiere        filiere         @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  module         module          @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  groupe         groupe          @relation(fields: [groupeId], references: [id], onDelete: Cascade)
  professor      user?           @relation("ProfSeances", fields: [profId], references: [id], onDelete: SetNull)
  attendances    attendance[]
  justifications justification[]

  @@map("seance")
}

enum seance_status {
  PLANNED
  OPEN
  CLOSED
}

model enrollment {
  id        String   @id @default(cuid()) @db.VarChar(25)
  studentId String   @db.VarChar(25)
  groupeId  String   @db.VarChar(25)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student user   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  groupe  groupe @relation(fields: [groupeId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupeId])
  @@map("enrollment")
}

model attendance {
  id        String            @id @default(cuid()) @db.VarChar(25)
  studentId String            @db.VarChar(25)
  seanceId  String            @db.VarChar(25)
  status    attendance_status @default(ABSENT)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  student user   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  seance  seance @relation(fields: [seanceId], references: [id], onDelete: Cascade)

  @@unique([studentId, seanceId])
  @@map("attendance")
}

enum attendance_status {
  PRESENT
  ABSENT
  LATE
}

model justification {
  id           String               @id @default(cuid()) @db.VarChar(25)
  studentId    String               @db.VarChar(25)
  seanceId     String               @db.VarChar(25)
  reason       String               @db.Text
  fileUrl      String?              @db.VarChar(500) // Chemin du fichier PDF ou image
  status       justification_status @default(PENDING)
  adminComment String?              @db.Text // Commentaire du professeur
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  student user   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  seance  seance @relation(fields: [seanceId], references: [id], onDelete: Cascade)

  @@unique([studentId, seanceId])
  @@map("justification")
}

enum justification_status {
  PENDING
  APPROVED
  REJECTED
}
